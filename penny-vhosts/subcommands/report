#!/usr/bin/env bash
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x
source "$PLUGIN_CORE_AVAILABLE_PATH/common/functions"

PENNY_DATA_DIR="$DOKKU_LIB_ROOT/data/penny-vhosts"

cmd-penny-vhosts-report() {
  declare desc="report penny properties for an app"
  declare cmd="penny-vhosts:report" argv=("$@")
  [[ "$1" == "$cmd" ]] && shift 1
  declare APP="$1"

  [[ -z "$APP" ]] && dokku_log_fail "Please specify an app name"

  local APP_DIR="$PENNY_DATA_DIR/$APP"
  local PROPERTIES="wait-period health-check cold-start-page start-timeout stop-timeout adaptive-wait min-wait-period max-wait-period low-req-per-hour high-req-per-hour"
  local DEFAULTS="wait-period:10m health-check:/ cold-start-page:true start-timeout:30s stop-timeout:30s adaptive-wait:false"

  dokku_log_info2_quiet "$APP penny-vhosts information"
  for prop in $PROPERTIES; do
    local value=""
    if [[ -f "$APP_DIR/$prop" ]]; then
      value=$(cat "$APP_DIR/$prop")
    fi

    local default=""
    for d in $DEFAULTS; do
      local dname="${d%%:*}"
      local dval="${d#*:}"
      if [[ "$dname" == "$prop" ]]; then
        default="$dval"
        break
      fi
    done

    if [[ -n "$value" ]]; then
      echo "       $prop: $value"
    elif [[ -n "$default" ]]; then
      echo "       $prop: $default (default)"
    else
      echo "       $prop: (not set)"
    fi
  done
}

cmd-penny-vhosts-report "$@"
