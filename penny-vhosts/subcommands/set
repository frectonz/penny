#!/usr/bin/env bash
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x
source "$PLUGIN_CORE_AVAILABLE_PATH/common/functions"

PENNY_DATA_DIR="$DOKKU_LIB_ROOT/data/penny-vhosts"

cmd-penny-vhosts-set() {
  declare desc="set a penny property for an app"
  declare cmd="penny-vhosts:set" argv=("$@")
  [[ "$1" == "$cmd" ]] && shift 1
  declare APP="$1" PROPERTY="$2" VALUE="$3"

  [[ -z "$APP" ]] && dokku_log_fail "Please specify an app name"
  [[ -z "$PROPERTY" ]] && dokku_log_fail "Please specify a property name"
  [[ -z "$VALUE" ]] && dokku_log_fail "Please specify a value"

  local VALID_PROPERTIES="wait-period health-check cold-start-page start-timeout stop-timeout adaptive-wait min-wait-period max-wait-period low-req-per-hour high-req-per-hour"
  local FOUND=false
  for p in $VALID_PROPERTIES; do
    if [[ "$p" == "$PROPERTY" ]]; then
      FOUND=true
      break
    fi
  done

  if [[ "$FOUND" != "true" ]]; then
    dokku_log_fail "Invalid property '$PROPERTY'. Valid properties: $VALID_PROPERTIES"
  fi

  local APP_DIR="$PENNY_DATA_DIR/$APP"
  mkdir -p "$APP_DIR"
  echo -n "$VALUE" >"$APP_DIR/$PROPERTY"
  dokku_log_info1 "Set $PROPERTY=$VALUE for $APP"
}

cmd-penny-vhosts-set "$@"
